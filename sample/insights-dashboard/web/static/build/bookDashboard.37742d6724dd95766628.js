webpackJsonp([13],{"./web/static/js/bookDashboard.js":function(t,e,n){"use strict";(function(t){function o(e){var n=t(".store-select-box").chosen().val(),o=t(".select-box-large.institution").chosen().val(),f=t(".select-box-large.book").chosen().val(),p=_.default.getDateRanges(),b=p.startDate,h=p.endDate;e.storeId&&(n=e.storeId),e.institutionIds&&(o=e.institutionIds),e.productIds&&(f=e.productIds),a(b,h,n,o,f),s(b,h,n,o,f),u(b,h,n,o,f),d(b,h,n,o,f),i(b,h,n,o,f),r(b,h,n,o,f),c(b,h,n,o,f),l(b,h,n,o,f)}function s(e,o,s,a,i){t.post("/events",{storeId:[s],startDate:e,endDate:o,dimension:"day",eventTypes:["noteAdd"],institutionIds:a,productIds:i,_csrf:P},function(t){if(t.success)return f("book-notes","column",b(t.data));n.e(0).then(function(){n("./web/static/js/flash.js").default.render({payload:t})}.bind(null,n)).catch(n.oe)})}function a(e,o,s,a,i){t.post("/events",{storeId:[s],startDate:e,endDate:o,dimension:"day",eventTypes:["bookOpen"],institutionIds:a,productIds:i,_csrf:P},function(t){if(t.success)return f("book-open","column",b(t.data));n.e(0).then(function(){n("./web/static/js/flash.js").default.render({payload:t})}.bind(null,n)).catch(n.oe)})}function i(e,o,s,a,i){t.post("/events",{storeId:[s],startDate:e,endDate:o,dimension:"day",eventTypes:["searchResult"],institutionIds:a,productIds:i,_csrf:P},function(t){if(t.success)return f("book-search","column",b(t.data));n.e(0).then(function(){n("./web/static/js/flash.js").default.render({payload:t})}.bind(null,n)).catch(n.oe)})}function r(e,o,s,a,i){t.post("/events",{storeId:[s],startDate:e,endDate:o,dimension:"day",eventTypes:["highlightAdd"],institutionIds:a,productIds:i,_csrf:P},function(t){if(t.success)return f("book-highlight","column",b(t.data));n.e(0).then(function(){n("./web/static/js/flash.js").default.render({payload:t})}.bind(null,n)).catch(n.oe)})}function d(e,o,s,a,i){t.post("/events",{storeId:[s],startDate:e,endDate:o,dimension:"day",eventTypes:["bookDownloadComplete"],institutionIds:a,productIds:i,_csrf:P},function(t){if(t.success)return f("book-download","column",b(t.data));n.e(0).then(function(){n("./web/static/js/flash.js").default.render({payload:t})}.bind(null,n)).catch(n.oe)})}function c(e,o,s,a,i){t.post("/books/top",{storeId:s,startDate:e,endDate:o,events:["bookDownloadComplete"],institutionIds:a,productIds:i,limit:5,_csrf:P},function(t){if(t.success)return h("top-book-download","column",m(t.data));n.e(0).then(function(){n("./web/static/js/flash.js").default.render({payload:t})}.bind(null,n)).catch(n.oe)})}function l(e,o,s,a,i){t.post("/books/top",{storeId:s,startDate:e,endDate:o,events:["bookOpen"],institutionIds:a,productIds:i,limit:5,_csrf:P},function(t){if(t.success)return h("top-book-open","column",m(t.data));n.e(0).then(function(){n("./web/static/js/flash.js").default.render({payload:t})}.bind(null,n)).catch(n.oe)})}function u(e,o,s,a,i){t.post("/books/timespent/summary",{storeId:s,startDate:e,endDate:o,institutionIds:a,productIds:i,_csrf:P},function(t){if(t.success)return p("book-timespent","area",g(t.data));n.e(0).then(function(){n("./web/static/js/flash.js").default.render({payload:t})}.bind(null,n)).catch(n.oe)})}function f(t,e,n){k.a.chart(document.getElementsByClassName(t)[0],{chart:{type:e,backgroundColor:"transparent",zoomType:"xy"},credits:{enabled:!1},title:{text:n.length?null:"No data"},xAxis:{type:"datetime",dateTimeLabelFormats:{day:"%e %b '%y"},labels:{style:{fontSize:"13px"}}},yAxis:{title:{text:"Count"}},legend:{enabled:!1},tooltip:{shared:!1,formatter:function(){return k.a.dateFormat("%e %b, %Y",this.x)+"<br />"+this.series.name+": <b>"+this.y+"</b>"}},series:n})}function p(t,e,n){k.a.chart(document.getElementsByClassName(t)[0],{chart:{type:e,backgroundColor:"transparent",zoomType:"xy"},credits:{enabled:!1},title:{text:n.length?null:"No data"},xAxis:{type:"datetime",dateTimeLabelFormats:{day:"%e %b '%y"},labels:{style:{fontSize:"13px"}}},yAxis:{title:{text:"Hours"},labels:{formatter:function(){var t=this.value,e=void 0,n=void 0;return this.value=1e3*t,e=t/60|0,t-=60*e,n=e/60|0,e-=60*n,n}},startOnTick:!1,showFirstLabel:!1},legend:{enabled:!1},tooltip:{shared:!1,formatter:function(){var t=parseInt(this.y/3600)%24,e=parseInt(this.y/60)%60,n=this.y%60;return t=t<10?"0"+t:t,e=e<10?"0"+e:e,n=n<10?"0"+n:n,k.a.dateFormat("%e %b, %Y",this.x)+"<br />"+this.series.name+": <b>"+t+":"+e+":"+n+"</b>"}},series:n})}function b(t){var e={},n=J()(T()(t,"timestamp")),o=J()(T()(t,"segment")),s=T()(o,function(t){return{name:t?t:"Count",data:[]}});return A()(t,function(t){A()(n,function(n){t.timestamp===n&&(e[n]||(e[n]=[]),e[n].push({count:t.count,segment:t.segment?t.segment:"Count"}))})}),A()(e,function(t,e){A()(t,function(t){A()(s,function(n){n.name===t.segment&&n.data.push([D()(1e3*e).utc().valueOf(),+t.count])})})}),s}function h(t,e,n){k.a.chart(document.getElementsByClassName(t)[0],{chart:{type:e,backgroundColor:"transparent",zoomType:"xy"},credits:{enabled:!1},title:{text:n.length?null:"No data"},xAxis:{type:"category",labels:{style:{fontSize:"13px"}}},plotOptions:{series:{stacking:"normal"}},yAxis:{title:{text:"Activity count"}},legend:{enabled:!1},tooltip:{formatter:function(){return"Name : "+this.point.name+" <br/> Count :  "+this.y}},series:n,exporting:{chartOptions:{plotOptions:{series:{dataLabels:{enabled:!1}}}},scale:3}})}function m(t){return t.length?[{name:"Books",data:T()(t,function(t){return[t.name?t.name+" ("+t.format+")":t.id+" ("+t.format+")",t.count]})}]:[]}function g(t){return t.length?[{name:"Time spent",data:T()(t,function(t){return[D()(1e3*t.timestamp).utc().valueOf(),t.duration]})}]:[]}function y(e){e||(e=t(".store-select-box").chosen().val());var o="institutions:"+e;if("undefined"!=typeof Storage&&void 0!==sessionStorage[o]){var s=JSON.parse(sessionStorage[o]);if(s.length)return v(s)}t.post("/institutions",{storeId:e,_csrf:P},function(t){if(t.success)return"undefined"!=typeof Storage&&(sessionStorage[o]=JSON.stringify(t.data)),v(t.data);n.e(0).then(function(){n("./web/static/js/flash.js").default.render({payload:t})}.bind(null,n)).catch(n.oe)})}function v(e){var n=R.institutionIds,o="";t(".select-box-large.institution option").remove(),o=q()(e,function(t,e){return t+"<option "+(E()(n,e.id)!=-1?'selected="selected"':"")+' value="'+e.id+'">'+e.name+"</option>"},""),t(".select-box-large.institution").append(o),t(".select-box-large.institution").chosen().trigger("chosen:updated")}function x(e){e||(e=t(".store-select-box").chosen().val());var o="books:"+e;if("undefined"!=typeof Storage&&void 0!==sessionStorage[o]){var s=JSON.parse(sessionStorage[o]);if(s.length)return I(s)}t.post("/books",{storeId:e,_csrf:P},function(t){if(t.success)return"undefined"!=typeof Storage&&(sessionStorage[o]=JSON.stringify(t.data)),I(t.data);n.e(0).then(function(){n("./web/static/js/flash.js").default.render({payload:t})}.bind(null,n)).catch(n.oe)})}function I(e){var n=R.productIds,o="";t(".select-box-large.book option").remove(),o=q()(e,function(t,e){return t+"<option "+(E()(n,e.id)!=-1?'selected="selected"':"")+' value="'+e.id+'">'+e.name+"</option>"},""),t(".select-box-large.book").append(o),t(".select-box-large.book").chosen().trigger("chosen:updated")}Object.defineProperty(e,"__esModule",{value:!0});var j=n("./node_modules/highcharts/highcharts.js"),k=n.n(j),w=n("./node_modules/moment/moment.js"),D=n.n(w),_=n("./web/static/js/datePicker.js"),S=n("./node_modules/qs/lib/index.js"),O=n.n(S),C=n("./node_modules/lodash/map.js"),T=n.n(C),N=n("./node_modules/lodash/forEach.js"),A=n.n(N),z=n("./node_modules/lodash/reduce.js"),q=n.n(z),F=n("./node_modules/lodash/uniq.js"),J=n.n(F),B=n("./node_modules/lodash/indexOf.js"),E=n.n(B),L=(n("./web/static/js/common.js"),n("./node_modules/chosen-npm/public/chosen.jquery.js")),P=(n.n(L),t("input[name=_csrf]").val()),R=O.a.parse(window.location.search.substring(1));A()([".store-select-box",".select-box-large.institution"],function(e){t(e).chosen({disable_search:!0})}),t(".btnApply").on("click",function(){o(R)}),t(".store-select-box").chosen().change(function(){y(),x()}),t(".select-box-large.institution").chosen(),t(".select-box-large.book").chosen(),_.default.setDatePicker('input[name="daterange"]'),t('.box-header > [data-toggle="tooltip"]').tooltip(),o(R),y(R.storeId),x(R.storeId),t(".book-details").on("click",function(e){e.preventDefault();var n=t(".store-select-box").chosen().val(),o=t(".select-box-large.institution").chosen().val(),s=t(".select-box-large.book").chosen().val(),a=t(this).data("event");window.location="/books/daily?"+O.a.stringify({storeId:n,institutionIds:o,productIds:s,event:a})}),t(".top-book-details").on("click",function(e){e.preventDefault();var n=t(".store-select-box").chosen().val(),o=t(".select-box-large.institution").chosen().val(),s=t(".select-box-large.book").chosen().val(),a=t(this).data("event");window.location="/books/activity?"+O.a.stringify({storeId:n,institutionIds:o,productIds:s,event:a})})}).call(e,n("./node_modules/jquery/dist/jquery.js"))}},["./web/static/js/bookDashboard.js"]);